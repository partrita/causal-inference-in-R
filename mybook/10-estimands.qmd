# 인과적 추정량 {#sec-estimands}

{{< include 00-setup.qmd >}}

```{r}
#| echo: false
# TODO: 첫 번째 판이 완료되면 제거
status("polishing")
```

## 추정량, 추정기, 추정치

인과 추론을 위해 분석할 때 관심 있는 인과적 질문을 가슴에 새겨야 합니다.
인과적 질문은 우리가 만들어야 하는 가정을 안내할 뿐만 아니라 질문에 답하는 방법도 안내합니다.
이 장에서는 인과적 질문에 답하는 것과 밀접하게 관련된 세 가지 아이디어, 즉 추정량, 추정기 및 추정치를 다룹니다.
**추정량**은 *관심 대상*이고, **추정기**는 데이터를 사용하여 이 추정량을 근사하는 방법이며, **추정치**는 데이터를 추정기에 입력했을 때 얻는 값입니다.
**추정량**을 우리가 굽고 싶은 아름다운 케이크의 광택 있는 그림으로, **추정기**를 레시피로, **추정치**를 오븐에서 꺼낸 케이크로 생각할 수 있습니다.

지금까지 우리는 평균 치료 효과, 즉 전체 모집단에 걸쳐 평균화된 관심 노출의 효과를 추정해 왔습니다.
여기서 **추정량**은 모든 개인에 대한 잠재적 결과의 차이의 기대값입니다.

$$E[Y(1) - Y(0)]$$

사용하는 **추정기**는 선택한 방법에 따라 다릅니다.
예를 들어, A/B 테스트 또는 무작위 통제 시험에서 추정기는 노출 A를 받은 사람들의 평균 결과에서 노출 B를 받은 사람들의 평균 결과를 뺀 것일 수 있습니다.

$$\sum_{i=1}^{N}\frac{Y_i\times X_i}{N_{\textrm{A}}} - \frac{Y_i\times (1-X_i)}{N_{\textrm{B}}}$$

여기서 $X$는 노출 A에 대한 지표($X = 1$은 노출 A, $X = 0$은 노출 B)이고, $N_A$는 A 그룹의 총 수, $N_B$는 B 그룹의 총 수이며, $N_A + N_B = N$입니다.
이 예를 좀 더 구체적으로 설명해 보겠습니다.
클릭 유도 문구(종종 CTA로 약칭되며, 마케팅 캠페인을 위한 서면 지시)에 대한 두 가지 다른 디자인이 있고 사용자가 구매하는 평균 항목 수에 다른 영향을 미치는지 평가하고 싶다고 가정해 보겠습니다.
사용자의 하위 집합을 무작위로 디자인 A 또는 디자인 B를 보도록 할당하는 A/B 테스트를 만들 수 있습니다.
`ab`라는 데이터셋에 100명의 참가자에 대한 A/B 테스트 데이터가 있다고 가정해 보겠습니다.
다음은 이러한 데이터셋을 시뮬레이션하는 코드입니다.

```{r}
#| eval: false
library(tidyverse)
set.seed(928)
ab <- tibble(
  # 이항 분포에서 노출 x 생성
  # 노출 A의 확률 0.5
  x = rbinom(100, 1, 0.5),
  # "실제" 평균 치료 효과 1 생성
  # 평균 0, 표준 편차 1인 정규 분포를 따르는
  # 무작위 오차 항을 추가하기 위해 rnorm(100) 사용
  y = x + rnorm(100)
)
```

여기서 노출은 `x`이고 결과는 `y`입니다.
실제 평균 치료 효과는 1이며, 이는 평균적으로 클릭 유도 문구 A를 보면 구매하는 항목 수가 1개 증가함을 의미합니다.

```{r}
#| code-fold: true
set.seed(928)
ab <- tibble(
  x = rbinom(100, 1, 0.5),
  y = x + rnorm(100)
)
ab |>
  summarize(
    n_a = sum(x),
    n_b = sum(1 - x),
    estimate = sum(
      (y * x) / n_a -
        y * (1 - x) / n_b
    )
  ) |>
  pull(estimate) -> estimate
```

```{r}
ab
```

아래는 R에서 이를 추정하는 두 가지 방법입니다.
공식 접근 방식을 사용하여 첫 번째 예에서 노출 값 간의 `y` 차이를 계산합니다.

```{r}
ab |>
  summarize(
    n_a = sum(x),
    n_b = sum(1 - x),
    estimate = sum(
      (y * x) / n_a -
        y * (1 - x) / n_b
    )
  )
```

또는 `x`로 `group_by()`하고 각 그룹에 대해 `y`의 평균을 `summarize()`한 다음 결과를 피벗하여 차이를 구할 수 있습니다.

```{r}
ab |>
  group_by(x) |>
  summarize(avg_y = mean(y)) |>
  pivot_wider(
    names_from = x,
    values_from = avg_y,
    names_prefix = "x_"
  ) |>
  summarize(estimate = x_1 - x_0)
```

노출인 $X$가 무작위로 할당되었기 때문에 이 추정기는 관심 있는 추정량의 편향되지 않은 추정치를 생성합니다.

하지만 편향되지 않았다는 것은 무엇을 의미할까요?
"실제" 인과 효과는 1이지만 이 추정치는 정확히 1이 아니라 `r round(estimate, 3)`입니다.
왜 차이가 날까요?
이 A/B 테스트에는 전체 모집단이 아닌 100명의 참가자 표본이 포함되었습니다.
표본이 증가하면 추정치가 실제 값에 더 가까워집니다.
시도해 보겠습니다.
데이터를 다시 시뮬레이션하되 표본 크기를 100에서 100,000으로 늘립니다.

```{r}
set.seed(928)
ab <- tibble(
  x = rbinom(100000, 1, 0.5),
  y = x + rnorm(100000)
)

ab |>
  summarize(
    n_a = sum(x),
    n_b = sum(1 - x),
    estimate = sum(
      (y * x) / n_a -
        y * (1 - x) / n_b
    )
  )
```

추정치가 1.01로 실제 평균 치료 효과 1에 훨씬 더 가깝다는 것을 알 수 있습니다.

$X$가 무작위로 할당되지 않았다고 가정해 보겠습니다.
이 경우 사전 노출 공변량을 사용하여 $X$의 조건부 확률(성향 점수)을 추정하고 이 확률을 *가중치* $(w_i)$에 통합하여 이 인과 효과를 추정할 수 있습니다.
예를 들어, 다음 *추정기*를 사용하여 평균 치료 효과 *추정량*을 *추정*할 수 있습니다.

$$\frac{\sum_{i=1}^NY_i\times X_i\times w_i}{\sum_{i=1}^NX_i\times w_i}-\frac{\sum_{i=1}^NY_i\times(1-X_i)\times w_i}{\sum_{i=1}^N(1-X_i)\times w_i}$$

## 특정 대상을 염두에 둔 치료 효과 추정하기

연구 목표 또는 인과적 질문에 따라 다른 *추정량*을 추정하고 싶을 수 있습니다.
여기서는 가장 일반적인 인과적 추정량, 대상 모집단, 답하는 데 도움이 될 수 있는 인과적 질문 및 이를 추정하는 데 사용되는 방법을 간략하게 설명합니다[@greifer2021choosing].

### 평균 치료 효과

일반적인 추정량은 평균 치료 효과(ATE)입니다.
대상 모집단은 관심 있는 *전체 표본* 또는 모집단입니다.
여기서 **추정량**은 모든 개인에 대한 잠재적 결과의 차이의 기대값입니다.

$$E[Y(1) - Y(0)]$$

연구 질문의 예는 "모든 적격 환자에게 정책을 적용해야 하는가?"입니다[@greifer2021choosing].

대부분의 무작위 통제 시험은 ATE를 대상 추정량으로 설계됩니다.
비무작위 환경에서는 전체 매칭을 사용하여 ATE를 추정할 수 있습니다.
노출된 그룹의 각 관찰은 대체 없이 대조군 그룹의 적어도 하나의 관찰과 일치됩니다.
또는 다음 역확률 가중치를 사용하여 성향 점수 가중치를 사용하여 ATE를 추정할 수 있습니다.

$$w_{ATE} = \frac{X}{p} + \frac{(1 - X)}{1 - p}$$

즉, 가중치는 노출 그룹에 있는 사람들의 경우 성향 점수의 역수이고 대조군 그룹의 경우 1에서 성향 점수를 뺀 값의 역수입니다.
직관적으로 이 가중치는 실제로 속한 노출 그룹에 있을 확률의 역수와 같습니다.

투어링 플랜 데이터를 사용하여 이 인과적 추정량에 대해 자세히 알아보겠습니다.
@sec-using-ps에서 아침에 "엑스트라 매직 아워"가 있었는지 여부와 당일 오전 9시에서 10시 사이 일곱 난쟁이 광산 열차의 평균 대기 시간 간의 관계를 검토했습니다.
데이터셋 `seven_dwarfs`를 재구성하고 이전에 지정한 것과 동일한 성향 점수 모델을 적합시켜 보겠습니다.

```{r}
library(broom)
library(touringplans)

seven_dwarfs <- seven_dwarfs_train_2018 |>
  filter(wait_hour == 9) |>
  mutate(park_extra_magic_morning = factor(
    park_extra_magic_morning,
    labels = c("매직 아워 없음", "엑스트라 매직 아워")
  ))

seven_dwarfs_with_ps <- glm(
  park_extra_magic_morning ~ park_ticket_season + park_close + park_temperature_high,
  data = seven_dwarfs,
  family = binomial()
) |>
  augment(type.predict = "response", data = seven_dwarfs)
```

이 데이터 프레임의 관심 변수 표를 살펴보겠습니다.
이를 위해 `{gtsummary}` 패키지의 `tbl_summary()` 함수를 사용할 것입니다.
(또한 표의 변수 이름을 정리하기 위해 `{labelled}` 패키지를 사용할 것입니다.)

```{r}
#| label: tbl-unweighted-gtsummary
#| tbl-cap: 투어링플랜 데이터셋의 엑스트라 매직 모닝 설명표. 이 표는 관찰된 모집단에서 이러한 변수의 분포를 보여줍니다.
library(gtsummary)
library(labelled)
seven_dwarfs_with_ps <- seven_dwarfs_with_ps |>
  set_variable_labels(
    park_ticket_season = "티켓 시즌",
    park_close = "폐장 시간",
    park_temperature_high = "과거 최고 기온"
  )

tbl_summary(
  seven_dwarfs_with_ps,
  by = park_extra_magic_morning,
  include = c(park_ticket_season, park_close, park_temperature_high)
) |>
  # 표에 전체 열 추가
  add_overall(last = TRUE)
```

@tbl-unweighted-gtsummary에서 아침에 엑스트라 매직 아워가 없었던 날은 294일이었고 있었던 날은 60일이었습니다.
또한 엑스트라 매직 모닝의 30%가 성수기였던 반면, 비 엑스트라 매직 모닝의 20%가 성수기였습니다.
또한 엑스트라 매직 아워가 있는 날은 오후 6시(18:00:00)에 문을 닫을 가능성이 더 높았습니다.
엑스트라 매직 아워 모닝이 있는 날의 평균 최고 기온은 비 엑스트라 매직 아워 모닝 날에 비해 약간 낮았습니다(83도).

이제 ATE를 추정하기 위해 성향 점수 가중치를 구성해 보겠습니다.
`{propensity}` 패키지에는 가중치를 추정하는 도우미 함수가 있습니다.
`wt_ate()` 함수는 ATE 가중치를 계산합니다.

```{r}
library(propensity)
seven_dwarfs_wts <- seven_dwarfs_with_ps |>
  mutate(w_ate = wt_ate(.fitted, park_extra_magic_morning))
```

이러한 가중치의 분포를 살펴보겠습니다.

```{r}
#| label: fig-sd-ate-hist
#| fig.cap: >
#|   하루에 엑스트라 매직 아워가 있었는지 여부에 대한 평균 치료 효과(ATE) 가중치 히스토그램. ATE 가중치는 1에서 무한대까지의 범위를 가질 수 있으므로 실제 가중치 범위에 주의하는 것이 중요합니다.
ggplot(seven_dwarfs_wts, aes(x = w_ate)) +
  geom_histogram(bins = 50)
```

@fig-sd-ate-hist의 많은 가중치는 1(ATE 가중치의 가능한 가장 작은 값)에 가깝고 가장 큰 가중치(약 24)로 이어지는 긴 꼬리가 있습니다.
이 분포는 ATE 가중치의 잠재적인 문제를 강조합니다.
1에서 무한대까지의 범위를 갖습니다. 작은 표본에서 가중치가 너무 크면 추정치에 편향이 발생할 수 있습니다(유한 표본 편향이라고 함).

::: callout-warning
## 유한 표본 편향

교란 변수를 설명하지 않으면 인과적 추정치가 편향될 수 있다는 것을 알고 있지만, 모든 교란 변수를 설명한 후에도 유한 표본에서는 여전히 편향된 추정치를 얻을 수 있음이 밝혀졌습니다.
통계에서 우리가 내세우는 많은 속성은 *큰 표본*에 의존하며, "큰"이 어떻게 정의되는지는 불투명할 수 있습니다.
간단한 시뮬레이션을 살펴보겠습니다.
여기에는 노출 $X$, 결과 $Y$ 및 하나의 교란 변수 $Z$가 있습니다.
$Z$에만 의존하는 $Y$(따라서 실제 치료 효과는 0)와 $Z$에도 의존하는 $X$를 시뮬레이션할 것입니다.

```{r}
set.seed(928)
n <- 100
finite_sample <- tibble(
  # z는 평균 0, 표준 편차 1인 정규 분포를 따릅니다.
  z = rnorm(n),
  # x는 정규 분포 오차를 갖는 프로빗 선택 모델에서 정의됩니다.
  x = case_when(
    0.5 + z + rnorm(n) > 0 ~ 1,
    TRUE ~ 0
  ),
  # y는 연속적이며, 정규 분포 오차를 갖는 z에만 의존합니다.
  y = z + rnorm(n)
)
```

하나의 교란 변수 $Z$를 사용하여 성향 점수 모델을 적합시키고 가중 추정기를 계산하면 편향되지 않은 결과를 얻어야 합니다(이 경우 0이 됨).

```{r}
## 성향 점수 모델 적합시키기
finite_sample_wts <- glm(
  x ~ z,
  data = finite_sample,
  family = binomial("probit")
) |>
  augment(data = finite_sample, type.predict = "response") |>
  mutate(wts = wt_ate(.fitted, x))

finite_sample_wts |>
  summarize(
    effect = sum(y * x * wts) / sum(x * wts) -
      sum(y * (1 - x) * wts) / sum((1 - x) * wts)
  )
```

자, 여기서 $X$의 효과는 0에서 꽤 멀리 떨어져 있지만, 이것이 정말 편향인지 아니면 이 특정 시뮬레이션된 표본에서 우연히 본 것인지 알기 어렵습니다.
유한 표본 편향의 가능성을 탐색하기 위해 서로 다른 표본 크기에서 이 시뮬레이션을 여러 번 다시 실행할 수 있습니다.
그렇게 해보겠습니다.

```{r}
#| label: sim-finite-sample-bias
#| warning: false
#| message: false
#| cache: true
sim <- function(n) {
  ## 시뮬레이션된 데이터셋 만들기
  finite_sample <- tibble(
    z = rnorm(n),
    x = case_when(
      0.5 + z + rnorm(n) > 0 ~ 1,
      TRUE ~ 0
    ),
    y = z + rnorm(n)
  )
  finite_sample_wts <- glm(
    x ~ z,
    data = finite_sample,
    family = binomial("probit")
  ) |>
    augment(data = finite_sample, type.predict = "response") |>
    mutate(wts = wt_ate(.fitted, x))
  bias <- finite_sample_wts |>
    summarize(
      effect = sum(y * x * wts) / sum(x * wts) -
        sum(y * (1 - x) * wts) / sum((1 - x) * wts)
    ) |>
    pull()
  tibble(
    n = n,
    bias = bias
  )
}

## 5가지 다른 표본 크기를 검토하고 각 표본 크기를 1000번 시뮬레이션합니다.
set.seed(1)
finite_sample_sims <- map_df(
  rep(
    c(50, 100, 500, 1000, 5000, 10000),
    each = 1000
  ),
  sim
)

bias <- finite_sample_sims |>
  group_by(n) |>
  summarize(bias = mean(bias))
```

결과를 그려 보겠습니다.

```{r}
#| label: fig-finite-sample-bias
#| fig-cap: "올바르게 지정된 성향 점수 모델을 사용하여 생성된 ATE 가중치에 존재하는 유한 표본 편향, 표본 크기를 n = 50에서 n = 10,000까지 변경"
ggplot(bias, aes(x = n, y = bias)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0, lty = 2)
```

이것은 유한 표본 편향의 예입니다.
여기서 표본 크기가 상당히 큰 경우(5,000)에도 여전히 "실제" 효과 0에서 약간의 편향이 있음을 알 수 있습니다.
표본 크기가 10,000보다 커질 때까지 이 편향이 사라지지 않습니다.

무한히 큰 값을 가질 수 있는 가중치를 사용하는 추정량은 유한 표본 편향을 겪을 가능성이 더 큽니다.
유한 표본 편향에 빠질 가능성은 다음에 따라 달라집니다.\
(1) 선택한 추정량(즉, 가중치가 제한되어 있는가?)\
(2) 노출군과 비노출군에서 공변량의 분포(즉, 좋은 중첩이 있는가? 중첩이 불량할 때 잠재적인 양성성 위반은 가중치가 너무 커질 수 있는 영역임)\
(3) 표본 크기.
:::

`{gtsummary}` 패키지를 사용하면 가중치를 통해 생성된 유사 모집단에 대한 직관을 구축하는 데 도움이 되는 *가중* 표를 만들 수 있습니다.
먼저 `{survey}` 패키지를 로드하고 설문 조사 설계 객체를 만들어야 합니다.
`{survey}` 패키지는 가중치를 사용한 통계 및 모델 계산을 지원합니다.
역사적으로 많은 연구자가 설문 조사 분석에 가중치를 통합하는 기법을 적용했습니다.
설문 조사 분석을 수행하지 않더라도 동일한 기법이 성향 점수 가중치에 유용합니다.

<!-- TODO: ATT와 같이 실제 모집단보다 작은 유사 모집단을 갖는 가중치의 경우 설문 조사에서 경고가 발생합니다. 이를 억제하고 있지만 설문 조사 또는 gtsummary에서 직접 수행할 수 있는 방법이 있기를 바랍니다. -->

```{r}
#| label: tbl-weighted-gtsummary
#| tbl-cap: 평균 치료 효과 가중치로 가중된 엑스트라 매직 모닝 시간 설명표. 이 표는 이러한 가중치로 생성된 유사 모집단에서 이러한 변수의 분포를 보여줍니다.
#| message: false
#| warning: false
library(survey)
library(halfmoon)
seven_dwarfs_svy <- svydesign(
  ids = ~1,
  data = seven_dwarfs_wts,
  weights = ~w_ate
)
tbl_svysummary(
  seven_dwarfs_svy,
  by = park_extra_magic_morning,
  include = c(park_ticket_season, park_close, park_temperature_high)
) |>
  add_ess_header() |>
  add_overall(last = TRUE)
```

@tbl-weighted-gtsummary에서 변수가 그룹 간에 더 **균형**을 이루고 있음을 알 수 있습니다.
예를 들어, `wdw_ticket_season` 변수를 보면 @tbl-unweighted-gtsummary에서 아침에 엑스트라 매직 아워가 있는 날의 비율이 성수기(30%)인 반면, 아침에 엑스트라 매직 아워가 없는 날의 비율은 23%였습니다.
@tbl-weighted-gtsummary에서는 이것이 균형을 이루어 엑스트라 매직 모닝 그룹의 성수기 날짜 가중 비율이 22%이고 엑스트라 매직 모닝이 없는 그룹의 성수기 날짜 가중 비율이 22%입니다.
가중치는 각 관찰에 가중치를 부여하여 두 그룹이 균형을 이루도록 변수의 분포를 변경합니다.
또한 @tbl-weighted-gtsummary의 변수 분포는 이제 @tbl-unweighted-gtsummary의 전체 열과 일치합니다.
이것이 ATE 가중치가 하는 일입니다. 즉, 각 노출 그룹에 대한 성향 점수에 포함된 변수의 분포를 전체 표본의 전체 분포와 유사하게 만듭니다.

ATE 가중치로 생성된 가중 유사 모집단을 이해하는 데 도움이 될 수 있는 또 다른 시각화인 미러 히스토그램을 살펴보겠습니다.
노출 그룹(아침에 엑스트라 매직 아워가 있는 날)의 성향 점수 분포를 플롯의 상단 절반에 그리고, 그 아래에 "비노출" 그룹의 성향 점수 분포를 미러링합니다. 이 시각화를 통해 두 분포를 빠르게 비교할 수 있습니다. 그런 다음 가중 히스토그램을 중첩하여 가중치를 통합한 후 이러한 분포가 어떻게 다른지 보여줍니다. {halfmoon} 패키지에는 이 시각화를 지원하는 `geom_mirror_histogram()` 함수가 포함되어 있습니다.

```{r}
#| label: fig-sd-mirror-hist-ate
#| fig.cap: >
#|   노출 그룹 간 성향 점수 분포의 미러 히스토그램. 어두운 막대는 가중되지 않은 분포를 나타내고 색상이 있는 막대는 평균 치료 효과(ATE) 가중치로 가중된 분포를 나타냅니다.
library(halfmoon)
ggplot(seven_dwarfs_wts, aes(.fitted, group = park_extra_magic_morning)) +
  geom_mirror_histogram(bins = 50) +
  geom_mirror_histogram(
    aes(fill = park_extra_magic_morning, weight = w_ate),
    bins = 50,
    alpha = 0.5
  ) +
  scale_y_continuous(labels = abs) +
  labs(
    x = "성향 점수",
    fill = "엑스트라 매직 모닝"
  )
```

@fig-sd-mirror-hist-ate에서 몇 가지를 알 수 있습니다.
첫째, 관찰된 모집단에서 "노출된" 날보다 "노출되지 않은" 날, 즉 아침에 엑스트라 매직 아워가 없는 날이 더 많다는 것을 알 수 있습니다.
관찰된 표본의 분포를 보여주는 어두운 히스토그램을 검토하여 이를 확인할 수 있습니다.
마찬가지로 노출된 날은 상단에 보이는 밝은 파란색에서 알 수 있듯이 더 실질적으로 상향 가중됩니다.
또한 가중 후 두 분포가 유사해 보인다는 것을 알 수 있습니다. 즉, 상단의 파란색 가중 분포 모양이 아래의 주황색 가중 분포와 비슷해 보입니다.

### 치료군 간 평균 치료 효과

치료군 간 평균 치료 효과(ATT)를 추정하기 위한 대상 모집단은 *노출된*(치료된) 모집단입니다.
이 인과적 추정량은 노출된 그룹의 사람들에 대해 조건화합니다.

$$E[Y(1) - Y(0) | X = 1]$$

ATT가 관심 대상인 연구 질문의 예로는 "현재 마케팅 캠페인을 받고 있는 사람들에게 마케팅 캠페인을 중단해야 하는가?" 또는 "의료 제공자는 현재 치료를 받고 있는 사람들에게 치료를 권장하는 것을 중단해야 하는가?"가 있습니다[@greifer2021choosing].

ATT는 매칭을 사용할 때 일반적인 대상 추정량입니다. 여기서 모든 노출된 관찰은 포함되고 대조군 관찰과 "일치"되며, 그중 일부는 버려질 수 있습니다.
또는 가중치를 통해 ATT를 추정할 수 있습니다.
ATT 가중치는 다음과 같이 추정됩니다.

$$w_{ATT} = X + \frac{(1 - X)p}{1 - p}$$

`seven_dwarfs_wts` 데이터 프레임에 ATT 가중치를 추가하고 분포를 살펴보겠습니다.

```{r}
#| label: fig-sd-att-hist
#| fig.cap : >
#|   처리된 그룹(ATT) 가중치에 대한 평균 처리 효과 히스토그램. 이 예에서 ATT 가중치의 범위는 ATE 가중치보다 더 안정적입니다. 즉, 범위가 훨씬 작습니다.
seven_dwarfs_wts <- seven_dwarfs_wts |>
  mutate(w_att = wt_att(.fitted, park_extra_magic_morning))

ggplot(seven_dwarfs_wts, aes(w_att)) +
  geom_histogram(bins = 50)
```

ATE 가중치와 비교하여 @fig-sd-att-hist의 가중치는 더 *안정적*으로 보입니다. 즉, 가중치 분포가 심하게 왜곡되지 않았고 범위가 0에서 1보다 약간 큰 값까지 작으며, 많은 가중치가 정확히 1입니다.
이러한 가중치는 노출된 그룹의 모든 날에 대해 정확히 1입니다.
이론적으로 노출되지 않은 날의 경우 이러한 가중치는 0에서 무한대까지의 범위를 가질 수 있습니다.
그러나 이 특정 표본에서는 노출된 날에 비해 노출되지 않은 날이 훨씬 많기 때문에 범위가 훨씬 작습니다. 즉, 대부분의 노출되지 않은 날은 노출된 날의 변수 분포와 일치하도록 "하향 가중"됩니다.
가중 표를 살펴보면 이를 좀 더 명확하게 알 수 있습니다.

```{r}
#| label: tbl-weighted-att
#| tbl-cap: 처리된 그룹 가중치에 대한 평균 처리 효과로 가중된 엑스트라 매직 모닝 시간 설명표. 이 표는 이러한 가중치로 생성된 유사 모집단에서 이러한 변수의 분포를 보여줍니다.
#| message: false
#| warning: false
seven_dwarfs_svy <- svydesign(
  ids = ~1,
  data = seven_dwarfs_wts,
  weights = ~w_att
)
tbl_svysummary(
  seven_dwarfs_svy,
  by = park_extra_magic_morning,
  include = c(park_ticket_season, park_close, park_temperature_high)
) |>
  add_ess_header() |>
  add_overall(last = TRUE)
```

그룹 간에 다시 균형을 이루지만 @tbl-weighted-att의 대상 값은 이전 표와 다릅니다.
ATE 가중 표(@tbl-weighted-gtsummary)를 회상하면 `wdw_ticket_season` 변수를 볼 때 성수기의 가중 비율이 관찰된 표본의 성수기 날짜 전체 비율인 22%에 가깝게 균형을 이루는 것을 보았습니다.
다시 균형을 이루지만 성수기 날짜의 가중 비율은 노출군과 비노출군 모두 30%이며, 이는 비가중 노출군의 비율을 반영합니다.
@tbl-weighted-att를 비가중 표(@tbl-unweighted-gtsummary)와 비교하면 열이 비가중 표의 노출군 열과 가장 유사하다는 것을 알 수 있습니다.
이는 "대상" 모집단이 노출군, 즉 아침에 엑스트라 매직 아워가 있는 날이기 때문이므로 비교 그룹(매직 아워 없음)을 해당 그룹과 최대한 유사하게 만들려고 합니다.

가중 유사 모집단을 관찰하기 위해 다시 미러 히스토그램을 만들 수 있습니다.

```{r}
#| label: fig-sd-mirror-hist-att
#| fig.cap: >
#|   노출 그룹 간 성향 점수 분포의 미러 히스토그램. 어두운 막대는 가중되지 않은 분포를 나타내고 색상이 있는 막대는 처리된 그룹(ATT) 가중치에 대한 평균 처리 효과로 가중된 분포를 나타냅니다.
ggplot(seven_dwarfs_wts, aes(.fitted, group = park_extra_magic_morning)) +
  geom_mirror_histogram(bins = 50) +
  geom_mirror_histogram(
    aes(fill = park_extra_magic_morning, weight = w_att),
    bins = 50,
    alpha = 0.5
  ) +
  scale_y_continuous(labels = abs) +
  labs(
    x = "성향 점수",
    fill = "엑스트라 매직 모닝"
  )
```

노출된 그룹의 모든 날은 가중치가 1이므로 @fig-sd-mirror-hist-att의 성향 점수 분포(그래프에서 0보다 큰 어두운 막대)는 파란색으로 중첩된 가중 분포와 정확히 일치합니다.
노출되지 않은 모집단에서는 거의 모든 관찰이 *하향 가중*됩니다. 즉, 어두운 주황색 분포는 성향 점수 분포보다 작고 그 위의 노출된 분포와 더 밀접하게 일치합니다.
ATT는 노출된 그룹에 비해 노출되지 않은 그룹에 관찰이 훨씬 더 많을 때 추정하기가 더 쉽습니다.

### 비노출군 간 평균 치료 효과

비노출군(대조군) 간 평균 치료 효과(ATU / ATC)를 추정하기 위한 대상 모집단은 *비노출된*(대조군) 모집단입니다.
이 인과적 추정량은 비노출된 그룹의 사람들에 대해 조건화합니다.

$$E[Y(1) - Y(0) | X = 0]$$

ATU가 관심 대상인 연구 질문의 예로는 "현재 마케팅 캠페인을 받지 않는 사람들에게 마케팅 캠페인을 보내야 하는가?" 또는 "의료 제공자는 현재 치료를 받지 않는 사람들에게 치료를 권장하기 시작해야 하는가?"가 있습니다[@greifer2021choosing].

ATU는 매칭을 통해 추정할 수 있습니다. 여기서 모든 비노출된 관찰은 포함되고 노출된 관찰과 "일치"되며, 그중 일부는 버려질 수 있습니다.
또는 가중치를 통해 ATU를 추정할 수 있습니다.
ATU 가중치는 다음과 같이 추정됩니다.

$$w_{ATU} = \frac{X(1-p)}{p}+ (1-X)$$ `seven_dwarfs_wts` 데이터 프레임에 ATU 가중치를 추가하고 분포를 살펴보겠습니다.

```{r}
#| label: fig-sd-atu-hist
#| fig.cap : >
#|   비노출군(ATU) 가중치에 대한 평균 치료 효과 히스토그램. 이 예에서 ATU 가중치의 범위는 ATE 가중치와 매우 유사합니다.
seven_dwarfs_wts <- seven_dwarfs_wts |>
  mutate(w_atu = wt_atu(.fitted, park_extra_magic_morning))

ggplot(seven_dwarfs_wts, aes(w_atu)) +
  geom_histogram(bins = 50)
```

@fig-sd-atu-hist 가중치의 분포는 ATE 가중치에서 본 것과 매우 유사해 보입니다. 즉, 1 근처에 여러 개가 있고 긴 꼬리가 있습니다.
이러한 가중치는 노출되지 않은 그룹의 모든 관찰에 대해 1이 됩니다. 노출된 그룹의 경우 0에서 무한대까지의 범위를 가질 수 있습니다.
노출되지 않은 그룹에 관찰이 더 많기 때문에 노출된 관찰은 분포와 일치하도록 상향 가중됩니다.

이제 가중 표를 살펴보겠습니다.

```{r}
#| label: tbl-weighted-atu
#| tbl-cap: 비노출군 가중치에 대한 평균 치료 효과로 가중된 엑스트라 매직 모닝 시간 설명표. 이 표는 이러한 가중치로 생성된 유사 모집단에서 이러한 변수의 분포를 보여줍니다.
#| warning: false

seven_dwarfs_svy <- svydesign(
  ids = ~1,
  data = seven_dwarfs_wts,
  weights = ~w_atu
)
tbl_svysummary(
  seven_dwarfs_svy,
  by = park_extra_magic_morning,
  include = c(park_ticket_season, park_close, park_temperature_high)
) |>
  add_ess_header() |>
  add_overall(last = TRUE)
```

이제 @tbl-weighted-atu의 노출된 열은 가중되지 않은 표의 노출되지 않은 열과 일치하도록 가중됩니다.

가중 유사 모집단을 관찰하기 위해 다시 미러 히스토그램을 만들 수 있습니다.

```{r}
#| label: fig-sd-mirror-hist-atu
#| fig.cap: >
#|   노출 그룹 간 성향 점수 분포의 미러 히스토그램. 어두운 막대는 가중되지 않은 분포를 나타내고 색상이 있는 막대는 비노출군(ATU) 가중치에 대한 평균 치료 효과로 가중된 분포를 나타냅니다.
ggplot(seven_dwarfs_wts, aes(.fitted, group = park_extra_magic_morning)) +
  geom_mirror_histogram(bins = 50) +
  geom_mirror_histogram(
    aes(fill = park_extra_magic_morning, weight = w_atu),
    bins = 50,
    alpha = 0.5
  ) +
  scale_y_continuous(labels = abs) +
  labs(
    x = "성향 점수",
    fill = "엑스트라 매직 모닝"
  )
```

노출되지 않은 날의 가중치는 모두 1이므로 이 그룹의 성향 점수 분포는 주황색의 가중 유사 모집단과 정확히 일치합니다.
파란색 막대는 노출된 모집단이 노출되지 않은 분포와 일치하도록 대체로 상향 가중됨을 나타냅니다.

### 균등하게 일치 가능한 그룹 간 평균 치료 효과

균등하게 일치 가능한 그룹 간 평균 치료 효과(ATM)를 추정하기 위한 대상 모집단은 균등하게 일치 가능한 그룹입니다.
이 인과적 추정량은 일부 거리 측정값에 의해 "균등하게 일치 가능"하다고 간주되는 사람들에 대해 조건화합니다.

$$E[Y(1) - Y(0) | M_d = 1]$$

여기서 $d$는 거리 측정값을 나타내고 $M_d=1$은 해당 거리 측정값 하에서 단위가 균등하게 일치 가능함을 나타냅니다.[@samuels2017aspects; @d2018improving] ATM이 관심 대상인 연구 질문의 예로는 "임상적 균형 상태에 있는 사람들이 노출을 받아야 하는가?"가 있습니다[@greifer2021choosing].

ATM은 매칭을 사용할 때 일반적인 대상 추정량입니다.
여기서 일부 노출된 관찰은 대조군 관찰과 "일치"되지만 두 그룹의 일부 관찰은 버려질 수 있습니다.
이는 종종 "캘리퍼"를 통해 수행되며, 관찰은 서로 미리 지정된 캘리퍼 거리 내에 있는 경우에만 일치됩니다.
또는 가중치를 통해 ATM을 추정할 수 있습니다.
ATM 가중치는 다음과 같이 추정됩니다.

$$w_{ATM} = \frac{\min \{p, 1-p\}}{Xp + (1-X)(1-p)}$$

`seven_dwarfs_wts` 데이터 프레임에 ATM 가중치를 추가하고 분포를 살펴보겠습니다.

```{r}
#| label: fig-sd-atm-hist
#| fig.cap: >
#|   하루에 엑스트라 매직 아워가 있었는지 여부에 대한 균등하게 일치 가능한 그룹(ATM) 가중치에 대한 평균 치료 효과 히스토그램. ATM 가중치는 0에서 1까지의 범위를 가질 수 있으므로 항상 안정적입니다.
seven_dwarfs_wts <- seven_dwarfs_wts |>
  mutate(w_atm = wt_atm(.fitted, park_extra_magic_morning))

ggplot(seven_dwarfs_wts, aes(w_atm)) +
  geom_histogram(bins = 50)
```

@fig-sd-atm-hist의 가중치 분포는 ATT 가중치에서 본 것과 매우 유사해 보입니다.
이는 이 특정 표본에서는 노출된 관찰에 비해 노출되지 않은 관찰이 훨씬 많기 때문입니다.
이러한 가중치는 0에서 1까지의 범위를 갖는 좋은 속성을 가지고 있어 노출 그룹 간의 불균형에 관계없이 *항상* 안정적입니다.

이제 가중 표를 살펴보겠습니다.

```{r}
#| label: tbl-weighted-atm
#| tbl-cap: 균등하게 일치 가능한 그룹 가중치에 대한 평균 치료 효과로 가중된 엑스트라 매직 모닝 시간 설명표. 이 표는 이러한 가중치로 생성된 유사 모집단에서 이러한 변수의 분포를 보여줍니다.
#| warning: false

seven_dwarfs_svy <- svydesign(
  ids = ~1,
  data = seven_dwarfs_wts,
  weights = ~w_atm
)
tbl_svysummary(
  seven_dwarfs_svy,
  by = park_extra_magic_morning,
  include = c(park_ticket_season, park_close, park_temperature_high)
) |>
  add_ess_header() |>
  add_overall(last = TRUE)
```

이 특정 표본에서 ATM 가중치는 ATT 가중치와 유사하므로 이 표는 ATT 가중 표와 유사해 보입니다.
이러한 유사성은 보장되지 않으며 ATM 유사 모집단은 전체, 노출된 및 노출되지 않은 비가중 모집단과 다르게 보일 수 있습니다.
따라서 ATM 가중치를 사용할 때는 궁극적으로 추론할 모집단을 이해하기 위해 이러한 가중 표를 검토하는 것이 중요합니다.

ATM 가중 유사 모집단을 관찰하기 위해 다시 미러 히스토그램을 만들 수 있습니다.

```{r}
#| label: fig-sd-mirror-hist-atm
#| fig.cap: >
#|   노출 그룹 간 성향 점수 분포의 미러 히스토그램. 어두운 막대는 가중되지 않은 분포를 나타내고 색상이 있는 막대는 균등하게 일치 가능한 그룹(ATM) 가중치에 대한 평균 치료 효과로 가중된 분포를 나타냅니다.
ggplot(seven_dwarfs_wts, aes(.fitted, group = park_extra_magic_morning)) +
  geom_mirror_histogram(bins = 50) +
  geom_mirror_histogram(
    aes(fill = park_extra_magic_morning, weight = w_atm),
    bins = 50,
    alpha = 0.5
  ) +
  scale_y_continuous(labels = abs) +
  labs(
    x = "성향 점수",
    fill = "엑스트라 매직 모닝"
  )
```

다시 말하지만, ATM 가중치는 0과 1로 제한되므로 모든 관찰이 *하향 가중*됩니다.
이는 작은 표본에서 큰 가중치로 인한 유한 표본 편향 가능성을 제거하고 분산 속성을 개선합니다.

### 중첩 모집단 간 평균 치료 효과

중첩 모집단 간 평균 치료 효과(ATO)를 추정하기 위한 대상 모집단은 중첩입니다. 이는 위에서 언급한 "균등하게 일치 가능"과 매우 유사합니다.
ATO가 관심 대상인 연구 질문의 예는 ATM과 동일합니다. 예를 들어, "임상적 균형 상태에 있는 사람들이 노출을 받아야 하는가?"입니다[@greifer2021choosing].

이러한 가중치는 다시 ATM 가중치와 매우 유사하지만 약간 약화되어 분산 속성이 향상됩니다.

ATO 가중치는 다음과 같이 추정됩니다.

$$w_{ATO} = X(1-p) + (1-X)p$$

`seven_dwarfs_wts` 데이터 프레임에 ATO 가중치를 추가하고 분포를 살펴보겠습니다.

```{r}
#| label: fig-sd-ato-hist
#| fig.cap: >
#|   하루에 엑스트라 매직 아워가 있었는지 여부에 대한 중첩 모집단(ATO) 가중치에 대한 평균 치료 효과 히스토그램. ATM 가중치와 마찬가지로 ATO 가중치는 0에서 1까지의 범위를 가질 수 있으므로 항상 안정적입니다. ATO 가중치는 또한 ATM 가중치에 비해 분산 속성이 향상되었습니다.
seven_dwarfs_wts <- seven_dwarfs_wts |>
  mutate(w_ato = wt_ato(.fitted, park_extra_magic_morning))

ggplot(seven_dwarfs_wts, aes(w_ato)) +
  geom_histogram(bins = 50)
```

ATM 가중치와 마찬가지로 ATO 가중치는 0과 1로 제한되어 노출군과 비노출군 불균형에 관계없이 ATE, ATT 및 ATU보다 더 안정적입니다.

::: callout-warning
## 유한 표본 편향 - 재검토

유한 표본 편향 시뮬레이션을 다시 살펴보면서 ATO 가중치를 추가하여 이 잠재적인 편향에 영향을 받는지 검토해 보겠습니다.

```{r}
#| label: sim-finite-sample-bias-2
#| warning: false
#| message: false
#| cache: true
sim <- function(n) {
  ## 시뮬레이션된 데이터셋 만들기
  finite_sample <- tibble(
    z = rnorm(n),
    x = case_when(
      0.5 + z + rnorm(n) > 0 ~ 1,
      TRUE ~ 0
    ),
    y = z + rnorm(n)
  )
  finite_sample_wts <- glm(
    x ~ z,
    data = finite_sample,
    family = binomial("probit")
  ) |>
    augment(data = finite_sample, type.predict = "response") |>
    mutate(
      wts_ate = wt_ate(.fitted, x),
      wts_ato = wt_ato(.fitted, x)
    )
  bias <- finite_sample_wts |>
    summarize(
      effect_ate = sum(y * x * wts_ate) / sum(x * wts_ate) -
        sum(y * (1 - x) * wts_ate) / sum((1 - x) * wts_ate),
      effect_ato = sum(y * x * wts_ato) / sum(x * wts_ato) -
        sum(y * (1 - x) * wts_ato) / sum((1 - x) * wts_ato)
    )
  tibble(
    n = n,
    bias = c(bias$effect_ate, bias$effect_ato),
    weight = c("ATE", "ATO")
  )
}

## 5가지 다른 표본 크기를 검토하고 각 표본 크기를 1000번 시뮬레이션합니다.
set.seed(1)
finite_sample_sims <- map_df(
  rep(
    c(50, 100, 500, 1000, 5000, 10000),
    each = 1000
  ),
  sim
)

bias <- finite_sample_sims |>
  group_by(n, weight) |>
  summarize(bias = mean(bias))
```

결과를 그려 보겠습니다.

```{r}
#| label: fig-finite-sample-bias-2
#| fig-cap: "올바르게 지정된 성향 점수 모델을 사용하여 생성된 ATE 가중치(주황색) 및 ATO 가중치(파란색)에 대한 유한 표본 편향, 표본 크기를 n = 50에서 n = 10,000까지 변경"
ggplot(bias, aes(x = n, y = bias, color = weight)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0, lty = 2)
```

여기서 ATO 가중치를 사용한 추정치는 상당히 작은 표본에서도 거의 즉시 편향되지 않음을 알 수 있습니다.
:::

이제 가중 표를 살펴보겠습니다.

```{r}
#| label: tbl-weighted-ato
#| tbl-cap: 중첩 모집단 가중치에 대한 평균 치료 효과로 가중된 엑스트라 매직 모닝 시간 설명표. 이 표는 이러한 가중치로 생성된 유사 모집단에서 이러한 변수의 분포를 보여줍니다.
#| warning: false

seven_dwarfs_svy <- svydesign(
  ids = ~1,
  data = seven_dwarfs_wts,
  weights = ~w_ato
)
tbl_svysummary(
  seven_dwarfs_svy,
  by = park_extra_magic_morning,
  include = c(park_ticket_season, park_close, park_temperature_high)
) |>
  add_ess_header() |>
  add_overall(last = TRUE)
```

ATM 가중치와 마찬가지로 ATO 유사 모집단은 전체, 노출된 또는 노출되지 않은 비가중 모집단과 유사하지 않을 수 있으므로 추론할 모집단을 이해하기 위해 이러한 가중 표를 검토하는 것이 중요합니다.

ATO 가중 유사 모집단을 관찰하기 위해 다시 미러 히스토그램을 만들 수 있습니다.

```{r}
#| label: fig-sd-mirror-hist-ato
#| fig.cap: >
#|   노출 그룹 간 성향 점수 분포의 미러 히스토그램. 어두운 막대는 가중되지 않은 분포를 나타내고 색상이 있는 막대는 중첩 모집단(ATO) 가중치에 대한 평균 치료 효과로 가중된 분포를 나타냅니다.
ggplot(seven_dwarfs_wts, aes(.fitted, group = park_extra_magic_morning)) +
  geom_mirror_histogram(bins = 50) +
  geom_mirror_histogram(
    aes(fill = park_extra_magic_morning, weight = w_ato),
    bins = 50,
    alpha = 0.5
  ) +
  scale_y_continuous(labels = abs) +
  labs(
    x = "성향 점수",
    fill = "엑스트라 매직 모닝"
  )
```

@fig-sd-mirror-hist-ato는 ATM 유사 모집단과 유사해 보이며, 노출된 모집단에서 하향 가중치가 증가함에 따라 약간 약화되었습니다.
중첩(또는 균등하게 일치 가능) 모집단이 대상인 경우 분산 속성이 향상되므로 ATO 가중치를 사용하는 것을 선호합니다.
또 다른 이점은 성향 점수 모델에 포함된 모든 변수(로지스틱 회귀를 통해 적합시킨 경우)가 평균에서 완벽하게 균형을 이룬다는 것입니다.
@sec-eval-ps-model에서 이에 대해 자세히 논의할 것입니다.

## 추정량 선택하기

특정 분석에 대한 추정량을 선택할 때 고려해야 할 몇 가지 요인이 있습니다.
무엇보다도 당면한 연구 질문이 이 결정을 주도할 것입니다.
예를 들어, 투어링 플랜 데이터로 돌아가서 디즈니가 현재 엑스트라 매직 아워가 없는 날에 추가 엑스트라 매직 아워를 추가해야 하는지 여부를 평가하는 데 관심이 있다고 가정해 보겠습니다. 여기서 ATU가 관심 있는 추정량이 될 것입니다.
다른 고려 사항으로는 사용 가능한 표본 크기와 노출군 및 비노출군 관찰의 분포(즉, 유한 표본 편향이 문제가 될 수 있는가?)가 있습니다.
아래는 추정량과 이를 추정하는 방법(R 함수 및 예제 코드 포함)을 요약한 표이며, @greifer2021choosing의 표 2에서 확장된 샘플 질문도 포함되어 있습니다.

+----------+----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------+------------------------+
| 추정량 | 대상 모집단                | 예시 연구 질문                                                                                                                                  | 매칭 방법                               | 가중치 부여 방법       |
+==========+==================================+============================================================================================================================================================+===============================================+========================+
| ATE      | 전체 모집단                  | 엑스트라 매직 아워를 *모든* 아침에 갖도록 결정하여 오후 5-6시 사이 일곱 난쟁이 광산 열차의 대기 시간을 변경해야 하는가?                       | 전체 매칭                                 | ATE 가중치            |
|          |                                  |                                                                                                                                                            |                                               |                        |
|          |                                  | 특정 정책을 모든 적격 관찰에 적용해야 하는가?                                                                                          | 미세 계층화                           | `propensity::wt_ate()` |
|          |                                  |                                                                                                                                                            |                                               |                        |
|          |                                  |                                                                                                                                                            | `MatchIt::matchit(…, estimand = "ATE")`       | |                      |
+----------+----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------+------------------------+
| ATT      | 노출된 (처리된) 관찰   | 엑스트라 매직 아워를 중단하여 오후 5-6시 사이 일곱 난쟁이 광산 열차의 대기 시간을 변경해야 하는가?                                                        | 캘리퍼 없는 쌍 매칭               | ATT 가중치            |
|          |                                  |                                                                                                                                                            |                                               |                        |
|          |                                  | 현재 마케팅 캠페인을 받고 있는 사람들에게 마케팅 캠페인을 중단해야 하는가?                                                                                     | 전체 매칭                                 | `propensity::wt_att()` |
|          |                                  |                                                                                                                                                            |                                               |                        |
|          |                                  | 의료 제공자는 현재 치료를 받고 있는 사람들에게 치료를 권장하는 것을 중단해야 하는가?                                                                     | 미세 계층화                           |                        |
|          |                                  |                                                                                                                                                            |                                               |                        |
|          |                                  |                                                                                                                                                            | `MatchIt::matchit(…, estimand = "ATT")`       |                        |
+----------+----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------+------------------------+
| ATU      | 노출되지 않은 (대조군) 관찰 | 모든 날에 엑스트라 매직 아워를 추가하여 오후 5-6시 사이 일곱 난쟁이 광산 열차의 대기 시간을 변경해야 하는가?                                            | 캘리퍼 없는 쌍 매칭               | ATU 가중치            |
|          |                                  |                                                                                                                                                            |                                               |                        |
|          |                                  | 마케팅 캠페인을 받지 않는 사람들에게 마케팅 캠페인을 확대해야 하는가?                                                                                         | 전체 매칭                                 | `propensity::wt_atu()` |
|          |                                  |                                                                                                                                                            |                                               |                        |
|          |                                  | 의료 제공자는 현재 치료를 받지 않는 사람들에게 치료를 확대해야 하는가?                                                                             | 미세 계층화                           |                        |
|          |                                  |                                                                                                                                                            |                                               |                        |
|          |                                  |                                                                                                                                                            | `MatchIt::matchit(…, estimand = "ATC")`       |                        |
+----------+----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------+------------------------+
| ATM      | 균등하게 일치 가능                 | 오후 5-6시 사이 일곱 난쟁이 광산 열차의 대기 시간을 변경하기 위해 엑스트라 매직 아워를 제공하는지 여부를 변경해야 하는 날이 있는가? | 캘리퍼 매칭                              | ATM 가중치            |
|          |                                  |                                                                                                                                                            |                                               |                        |
|          |                                  | 일부 관찰에 대해 노출의 효과가 있는가?                                                                                                  | `MatchIt::matchit(…, caliper = 0.1)`          | `propensity::wt_atm()` |
|          |                                  |                                                                                                                                                            |                                               |                        |
|          |                                  | 임상적 균형 상태에 있는 사람들이 치료를 받아야 하는가?                                                                                                      | 조잡한 정확 매칭                      |                        |
|          |                                  |                                                                                                                                                            |                                               |                        |
|          |                                  |                                                                                                                                                            | 카디널리티 매칭                          |                        |
|          |                                  |                                                                                                                                                            |                                               |                        |
|          |                                  |                                                                                                                                                            | `MatchIt::matchit(…, method = "cardinality")` |                        |
+----------+----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------+------------------------+
| ATO      | 중첩 모집단               | ATM과 동일                                                                                                                                                |                                               | ATO 가중치            |
|          |                                  |                                                                                                                                                            |                                               |                        |
|          |                                  |                                                                                                                                                            |                                               | `propensity::wt_ato()` |
+----------+----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------+------------------------+

## 위험비, 위험 차이 및 오즈비 {#sec-binary}

우리가 다룬 예에서 결과인 게시된 대기 시간은 연속적입니다.
선형 회귀를 사용하면 ATE 및 유사한 것은 평균 차이로 계산됩니다.
평균 차이는 추정하기에 유용한 효과이지만 유일한 것은 아닙니다.
ATT 가중치를 사용하고 결과 회귀에 가중치를 부여하여 게시된 대기 시간의 상대적 변화를 계산한다고 가정해 보겠습니다.
상대적 변화는 여전히 치료군 간의 치료 효과이지만 상대적 척도입니다.
중요한 부분은 가중치를 통해 추정하려는 특정 추정량에 대해 치료군의 공변량에 걸쳐 평균을 낼 수 있다는 것입니다.
때때로 사람들이 "평균 치료 효과"와 같은 것을 말할 때 전체 표본의 평균 결과 차이에 대해 이야기하므로 구체적으로 설명하는 것이 좋습니다.

이진 결과에 대한 세 가지 표준 옵션이 있습니다. 즉, 위험비, 위험 차이 및 오즈비입니다.
이진 결과의 경우 각 치료 그룹에 대한 평균 확률을 계산합니다.
이를 `p_untreated` 및 `p_treated`라고 부르겠습니다.
이러한 확률로 작업할 때 위험 차이와 위험비를 계산하는 것은 간단합니다.

-   **위험 차이**: `p_treated - p_untreated`
-   **위험비**: `p_treated / p_untreated`

::: callout-note
"위험"이란 결과의 위험을 의미합니다.
이는 질병 발생과 같이 결과가 부정적이라고 가정합니다.
때로는 이를 "반응비" 또는 "반응 차이"라고 설명하기도 합니다.
이에 대해 생각하는 더 일반적인 방법은 결과 확률의 차이 또는 비율입니다.
:::

확률에 대한 오즈는 `p / (1 - p)`로 계산되므로 오즈비는 다음과 같습니다.

-   **오즈비**: `(p_treated / (1 - p_treated)) /  (p_untreated / (1 - p_untreated))`

결과가 드물면 `(1 - p)`는 1에 가까워지고 오즈비는 위험비를 근사합니다.
결과가 드물수록 근사값은 더 가까워집니다.

로지스틱 회귀 모델의 한 가지 특징은 계수가 로그 오즈비이므로 지수화하면 오즈비가 생성된다는 것입니다.
그러나 로지스틱 회귀를 사용할 때 [Chapter -@sec-g-comp]에서 보게 되겠지만 예측된 확률로 작업하여 위험 차이와 비율을 계산할 수도 있습니다.

연속형 결과와 마찬가지로 모집단의 다른 하위 집합에 대해 이러한 각 추정량을 대상으로 할 수 있습니다. 예를 들어, 비치료군 간의 위험비, 균등하게 일치 가능한 그룹 간의 오즈비 등입니다.

이러한 옵션은 범주형 결과로도 확장됩니다.
범주형 변수의 성격에 따라 이를 구성하는 다양한 방법이 있습니다.
비순서 범주형 변수에 대해 일반적으로 추정되는 효과는 결과의 한 수준을 참조 수준으로 사용하는 일련의 오즈비입니다(예: 1 대 2 및 1 대 3 등에 대한 OR).
`nnet::multinom()`과 같은 다항 회귀 모델은 로지스틱 회귀의 확장인 이러한 로그 오즈비를 계수로 생성할 수 있습니다.
순서형 결과의 경우 `MASS::polr()`과 같은 순서형 로지스틱 회귀는 결과의 각 이전 값과 비교하는 일련의 로그 오즈비를 계산합니다.
로지스틱 회귀와 마찬가지로 각 범주의 예측된 확률로 작업하여 관심 있는 효과를 계산할 수 있으므로 이러한 확장에 대해 오즈비로 제한되지 않습니다.

::: callout-note
사례-대조 연구는 참가자가 결과 상태별로 표본 추출되는 역학에서 일반적인 설계입니다[@schlesselman1982case].
결과가 있는 사례가 접촉되고 사례가 나온 모집단에서 대조군이 표본 추출됩니다.
이러한 유형의 연구는 결과가 드물 때 사용됩니다.
또한 노출 시점부터 사람들을 추적하는 연구보다 더 빠르고 저렴할 수 있습니다.

사례-대조 연구에서 표본 추출이 이루어지는 방식 때문에 결과가 없었던 모든 개인을 가지고 있지 않으므로 기준선 위험이 없습니다.
흥미롭게도 여전히 오즈비를 복구할 수 있습니다.
결과가 드물면 오즈비는 위험비를 근사합니다.
그러나 위험 차이는 계산할 수 없습니다.
:::

### 절대적 및 상대적 측정값

위험 차이와 같은 절대적 측정값과 위험비 및 오즈비와 같은 상대적 측정값은 치료 효과에 대해 서로 다른 관점을 제공합니다.
결과의 기준선 확률에 따라 절대적 측정값과 상대적 측정값이 서로 다른 결론으로 이어질 수 있습니다.

기준선 확률이 0.0001인 드문 결과를 생각해 보십시오. 즉, 10,000건의 관찰당 1건의 사건이 발생합니다.
이것이 노출되지 않은 사람들의 확률입니다.
노출된 사람들의 결과 확률이 0.0008이라고 가정해 보겠습니다.
이는 노출되지 않은 사람들보다 8배 더 크며 상당한 상대적 효과입니다.
그러나 절대 척도에서는 0.0007에 불과합니다.

이제 기준선 확률이 0.20인 더 일반적인 결과를 생각해 보십시오.
노출된 그룹의 결과 확률은 0.40입니다.
이제 상대 위험은 2이고 위험 차이는 0.20입니다.
상대적 효과는 훨씬 작지만 결과가 더 널리 퍼져 있기 때문에 더 많은 결과 사건을 생성합니다.

흡연이 건강에 미치는 영향은 이에 대한 훌륭한 예입니다.
알다시피 흡연은 폐암의 상대적 위험을 급격히 증가시킵니다.
그러나 폐암은 매우 드문 질병입니다.
흡연은 또한 심장병 위험을 증가시키지만 상대적 효과는 폐암만큼 높지 않습니다.
그러나 심장병은 훨씬 더 널리 퍼져 있습니다.
절대적 위험 변화 때문에 폐암보다 흡연 관련 심장병으로 사망하는 사람이 더 많습니다.
절대적 관점과 상대적 관점 모두 유효합니다.

::: callout-note
## 치료에 필요한 수

확률 차이에 대한 또 다른 관점은 치료에 필요한 수(NNT) 측정값입니다.
이는 단순히 위험 차이의 역수이며, 하나의 결과를 예방하거나 생성하는 데 필요한 노출된 개인 수를 나타냅니다.

구매 확률이 5%인 판매 제품을 생각해 보십시오. 즉, 100명 중 5명이 이 제품을 구매합니다.
마케팅 팀이 광고를 만들고 광고를 본 사람들은 제품을 구매할 확률이 7%입니다.
제품 구매 확률의 절대 차이는 0.02이므로 구매 수를 하나 늘리려면 `1 / 0.02 = 50`명이 광고를 봐야 합니다.

NNT는 단순성 때문에 불완전한 측정값이지만 치료 효과가 실제로 실제로 무엇을 의미하는지에 대한 또 다른 관점을 제공합니다.
:::

### 비축소성 {#sec-non-collapse}

오즈비는 로지스틱 회귀와의 연관성 때문에 편리합니다.
또한 특이한 특성을 가지고 있습니다. 즉, *비축소성*입니다.
비축소성은 전체 표본(주변)과 하위 그룹(조건부)의 오즈비를 비교할 때 주변 오즈비가 조건부 오즈비의 가중 평균이 아님을 의미합니다[@Didelez2022; @Greenland2021; @Greenland2021a].
예를 들어 위험비에는 이러한 속성이 없습니다.
예를 살펴보겠습니다.

`outcome`, `exposure` 및 `covariate`가 있다고 가정해 보겠습니다.
`exposure`는 `outcome`을 유발하고 `covariate`도 마찬가지입니다[^11-estimands-1].
그러나 `covariate`는 `exposure`를 유발하지 않습니다. 즉, 교란 변수가 *아닙니다*.
즉, `exposure`가 `outcome`에 미치는 효과 추정치는 `covariate`를 설명하는지 여부에 관계없이 동일해야 합니다.

[^11-estimands-1]: `exposure`와 `outcome` 간에 관계가 없다면 둘 사이의 관계는 귀무 가설이 될 것이며, 이는 `covariate`의 유무에 관계없이 축소 가능합니다.

```{r}
#| code-fold: true
#| message: false
#| fig-width: 4
#| fig-height: 4
#| fig-align: "center"
#| fig-cap: "`outcome`, `exposure` 및 `covariate` 간의 인과 관계를 보여주는 DAG. `exposure`와 `covariate`는 모두 `outcome`을 유발하지만 `exposure`와 `covariate` 간에는 관계가 없습니다. 로지스틱 회귀에서 노출에 대한 오즈비는 공변량 계층에 걸쳐 비축소성입니다."
library(ggdag)
dagify(
  outcome ~ exposure + covariate,
  coords = time_ordered_coords()
) |>
  ggdag(use_text = FALSE) +
  geom_dag_text_repel(aes(label = name), box.padding = 1.8, direction = "x") +
  theme_dag()
```

시뮬레이션해 보겠습니다.

```{r}
set.seed(123)
n <- 10000

exposure <- rbinom(n, 1, 0.5)
covariate <- rbinom(n, 1, 0.5)
outcome <- rbinom(n, 1, plogis(-0.5 + exposure + 2 * covariate))
```

```{r}
#| echo: false
odds_ratio <- function(tbl) {
  or <- (tbl[2, 2] * tbl[1, 1]) / (tbl[1, 2] * tbl[2, 1])
  round(or, digits = 2)
}

risk_ratio <- function(tbl) {
  risk_exposed <- tbl[2, 2] / (tbl[2, 2] + tbl[2, 1])
  risk_unexposed <- tbl[1, 2] / (tbl[1, 2] + tbl[1, 1])
  round(risk_exposed / risk_unexposed, digits = 2)
}

marginal_table <- table(exposure, outcome)
marginal_or <- odds_ratio(marginal_table)
marginal_rr <- risk_ratio(marginal_table)
conditional_tables <- table(exposure, outcome, covariate)
conditional_or_0 <- odds_ratio(conditional_tables[, , 1])
conditional_or_1 <- odds_ratio(conditional_tables[, , 2])
conditional_rr_0 <- risk_ratio(conditional_tables[, , 1])
conditional_rr_1 <- risk_ratio(conditional_tables[, , 2])
```

먼저 모든 사람 사이에서 `exposure`와 `outcome` 간의 관계를 살펴보겠습니다.

```{r}
table(exposure, outcome)
```

이 빈도표를 사용하여 오즈비를 계산할 수 있습니다. 즉, ((`r marginal_table[2, 2]` \* `r marginal_table[1, 1]`) / (`r marginal_table[1, 2]` \* `r marginal_table[2, 1]`)) = `r marginal_or`입니다.

이 오즈비는 결과를 지수화할 때 로지스틱 회귀에서 얻는 결과와 동일합니다.

```{r}
glm(outcome ~ exposure, family = binomial()) |>
  broom::tidy(exponentiate = TRUE)
```

이것은 시뮬레이션 모델 계수 `exp(1)`과 약간 다릅니다.
`covariate`를 추가하면 더 가까워집니다.

```{r}
glm(outcome ~ exposure + covariate, family = binomial()) |>
  broom::tidy(exponentiate = TRUE)
```

`covariate`는 교란 변수가 아니므로 당연히 `exposure`에 대한 효과 추정치에 영향을 미치지 않아야 합니다.
`covariate`별 조건부 오즈비를 살펴보겠습니다.

```{r}
table(exposure, outcome, covariate)
```

`covariate = 0`인 경우의 오즈비는 `r conditional_or_0`입니다.
`covariate = 1`인 경우의 오즈비는 `r conditional_or_1`입니다.
주변 오즈비 `r marginal_or`는 이 두 가지보다 작습니다!

주변 위험비는 `r marginal_rr`입니다.
`covariate = 0`인 경우의 위험비는 `r conditional_rr_0`입니다.
`covariate = 1`인 경우의 위험비는 `r conditional_rr_1`입니다.
이 경우 주변 위험비는 `covariate` 계층에 걸쳐 축소 가능한 가중 평균입니다[@Huitfeldt2019].

`covariate`를 추가하면 오즈비가 변경되고 시뮬레이션의 모델 계수에 더 가까워지므로 포함해야 한다고 생각하기 쉽습니다.
여기서 중요한 세부 사항은 비축소성이 편향이 *아니라는* 것입니다.
일부 저자는 이를 누락된 변수 편향이라고 설명하지만, `covariate`가 교란 변수가 아니므로 주변 및 조건부 오즈비 모두 정확합니다.
단순히 다른 추정량일 뿐입니다.
조건부 오즈비는 `covariate`에 대한 조건부 OR입니다.
다른 오즈비와 의미 있게 비교하려면 해당 오즈비도 `covariate`에 대한 조건부여야 합니다.
비축소성은 오즈의 수치적 속성입니다. 편향을 생성하는 대신 약간 더 미묘한 해석을 생성합니다.
비축소성이 작동하는 정확한 방식은 데이터 생성 메커니즘이 가산 척도 또는 곱셈 척도에서 발생하는지 여부에 따라 달라집니다. 곱셈 척도(시뮬레이션에서와 같이)에서는 결과와 강력하게 관련된 변수를 제거하면 효과 추정치가 변경되는 반면, 가산 척도에서는 결과와 강력하게 관련된 변수를 추가하면 효과가 변경되지만 규모는 더 작습니다[@Whitcomb2021].
어떤 버전의 오즈비가 옳은지 걱정하는 대신 편향되지 않은 추정치에 필요한 교란 변수와 분산 감소에 유용한 결과 예측 변수에 초점을 맞추는 것이 좋습니다.

오즈비 대 위험비 및 상대적 척도 대 절대적 척도에 대해 많은 논의가 있었습니다.
결과의 기준선 확률과 함께 세 가지 측정값(오즈비, 위험비 및 위험 차이)을 모두 제시하는 것이 좋습니다.
각각은 인과 효과에 대해 서로 다른 관점을 제공합니다.
추정치에 포함한 치료 그룹과 관련하여 이를 해석하는 데 주의하십시오.
예를 들어, ATT 가중치로 계산된 평균 위험 차이는 치료군 간의 평균 위험 차이입니다.

::: callout-note
## 선형 확률 모델

선형 확률 모델은 이진 결과에 대한 치료 효과를 추정하는 또 다른 일반적인 방법입니다.
선형 확률 모델은 계량 경제학 및 기타 분야에서 표준입니다.
OLS일 뿐이지만 연구자들은 잔차 분산의 이질성 때문에 종종 강건한 표준 오차를 사용합니다.
결과는 축소 가능한 측정값인 위험 차이입니다.

```{r}
lm(outcome ~ exposure)
```

선형 확률 모델은 가산 척도에서 관계를 모델링하는 편리한 방법입니다.
그러나 상당한 문제가 있습니다. 즉, 로지스틱 회귀는 0과 1로 제한되는 반면 OLS는 그렇지 않습니다.
이는 개별 예측이 0보다 작거나 1보다 클 수 있음을 의미하며, 이는 확률에 대해 불가능한 값입니다.

[Chapter -@sec-g-comp]에서 로지스틱 회귀를 사용하여 위험 차이를 계산하는 대체 방법을 볼 것입니다.
:::

## 다변량 선형 회귀는 어떤 추정량을 대상으로 하는가?

@sec-strat-outcome에서는 다변량 선형 회귀와 같은 표준 방법이 성공하고 실패하는 경우에 대해 논의했습니다.
그러나 `lm(outcome ~ exposure + confounder)`와 같은 회귀 추정기는 어떤 추정량을 추정할까요?

간단한 문제를 탐색하는 동안 다변량 회귀에서 얻는 답이 ATE 가중치에 대해 얻는 답과 종종 가깝다는 것을 알 수 있습니다.
치료군 또는 비치료군이 불균형하게 높은 노출 분포를 가지고 있다면 ATT 또는 ATU에 더 가깝다고 생각할 수 있습니다.

현실은 우리가 어떤 추정량을 다루고 있는지 항상 명확하지 않다는 것입니다.
이를 조사하는 한 가지 방법은 선형 회귀에서 *암묵적인* 가중치를 도출하는 기법을 사용하는 것입니다[@chattopadhyay2022; @aronow2015].
lmw 패키지를 사용하면 이러한 가중치를 계산할 수 있습니다.
기본값은 ATE이지만 다른 추정량을 대상으로 할 수도 있습니다.

```{r}
library(lmw)
implied_weights <- lmw(
  ~ park_extra_magic_morning + park_ticket_season + park_close + park_temperature_high,
  data = seven_dwarfs_with_ps,
  treat = "park_extra_magic_morning"
)
seven_dwarfs_with_ps$iw <- implied_weights$weights
```

이러한 암묵적인 가중치에는 몇 가지 좋은 속성이 있습니다.
평균에서 완벽하게 균형을 이루고 이러한 가중치 중 분산이 가장 낮습니다.

```{r}
seven_dwarfs_with_ps |>
  mutate(park_close = as.numeric(park_close)) |>
  tidy_smd(
    .vars = c(park_ticket_season, park_close, park_temperature_high),
    .group = park_extra_magic_morning,
    .wts = iw
  ) |>
  ggplot(aes(abs(smd), variable, color = method, group = method)) +
  geom_love()
```

또한 평균이 1이므로 데이터셋의 원래 크기에 합산됩니다.

```{r}
seven_dwarfs_with_ps |>
  summarize(mean = mean(iw), sum = sum(iw), n = n())
```

문제는 몇 가지 일관성 없는 속성도 있다는 것입니다.
평균에서 균형을 이루더라도 대상 모집단에 대한 균형을 만들지 못할 수 있습니다.
관련하여 때때로 음수 가중치를 생성하기도 합니다.
예를 들어, 이 모델에 상호 작용 항을 추가하면 일부 가중치가 0보다 작습니다.
음수 가중치는 데이터의 공변량 공동 분포를 벗어난 외삽을 의미합니다.
여기서는 0에 가깝지만 더 극단적일 수 있습니다.
따라서 ATE를 대상으로 했지만 그다지 정확하게 수행하지 못했을 수 있습니다.

```{r}
implied_weights_int <- lmw(
  ~ park_extra_magic_morning * (park_ticket_season + park_close + park_temperature_high),
  data = seven_dwarfs_with_ps,
  treat = "park_extra_magic_morning"
)

min(implied_weights_int$weights)
```

이러한 속성이 문제에 대해 어떻게 작용했는지 괜찮다고 생각한다면 이 접근 방식은 추가적인 이점을 제공합니다. 즉, 이제 이 책의 기법을 사용하여 결과와 노출 간의 관계를 살펴보지 않고 다변량 선형 모델의 균형과 함수 형태를 진단할 수 있습니다.
단순히 가중치이므로 halfmoon, gtsummary 및 가중치 작업에 사용하는 다른 모든 접근 방식의 모든 도구를 여전히 사용할 수 있습니다.
lmw에는 강건한 표준 오차로 결과에 대한 효과를 계산하는 편리한 추정 함수 `lmw_est()`도 함께 제공됩니다.
따라서 공동 작업자가 OLS를 사용하고 싶지만 균형과 외삽에 대해 비판적으로 생각하고 싶다면 두 가지 모두의 장점을 가질 수 있습니다.
그러나 음수 가중치 및 기타 이상한 속성이 발생하면 추정량에 따라 다른 접근 방식을 사용하는 것이 더 나을 수 있습니다.

[Chapter -@sec-g-comp]에서 이와 같은 다변량 결과 모델을 사용하여 다른 추정량을 대상으로 하는 또 다른 방법을 논의할 것입니다.
